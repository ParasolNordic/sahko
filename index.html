<!doctype html>
<html lang="fi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>P√∂rssis√§hk√∂ ‚Äì Spot-hinnat (vartti)</title>
  <meta name="description" content="Mobiiliyst√§v√§llinen n√§kym√§ Suomen p√∂rssis√§hk√∂n varttihinnoille." />

  <!-- No robots (meta) -->
  <meta name="robots" content="noindex,nofollow,noarchive,nosnippet,noimageindex" />
  <meta name="googlebot" content="noindex,nofollow,noarchive,nosnippet,noimageindex" />
  <meta name="bingbot" content="noindex,nofollow,noarchive,nosnippet,noimageindex" />

  <meta name="theme-color" content="#0b1220" />

  <!-- No robots (best-effort script, runs ASAP) -->
  <script>
    (() => {
      try {
        const ua = (navigator.userAgent || "");
        const bot = /bot|crawler|spider|crawling|HeadlessChrome|Lighthouse|pagespeed|facebookexternalhit|Slackbot|Discordbot|TelegramBot|WhatsApp|Google-Read-Aloud/i;
        if (bot.test(ua)) {
          // Keep it empty for bots
          document.documentElement.innerHTML = "<head><meta name='robots' content='noindex,nofollow'></head><body></body>";
        }
      } catch (_) {}
    })();
  </script>

  <style>
    :root{
      --bg:#0b1220;
      --panel:#0f1a33;
      --text:#e8eefc;
      --muted:#aab7da;
      --border:rgba(255,255,255,.08);
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --ok:#53d18a;
      --warn:#ffd166;
      --bad:#ff5c7a;
      --accent:#7aa7ff;
      --accent2:#9b7dff;
      --focus: rgba(122,167,255,.35);
      --radius:18px;
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }
    *{box-sizing:border-box}
    html,body{height:100%;scroll-behavior:smooth}
    body{
      margin:0;
      font-family:var(--font);
      background: var(--bg);
      color:var(--text);
    }
    .wrap{max-width:1100px;margin:0 auto;padding:18px 14px 34px;}
    header{display:flex;align-items:flex-start;justify-content:space-between;gap:12px;margin:6px 0 14px;flex-wrap:wrap}
    .title{display:flex;flex-direction:column;gap:6px;min-width:240px}
    .title h1{font-size:18px;margin:0;letter-spacing:.2px;font-weight:750}
    .title p{margin:0;color:var(--muted);font-size:13px;line-height:1.35}
    .actions{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end;align-items:center}
    button{
      -webkit-tap-highlight-color: transparent;
      border:1px solid var(--border);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      color:var(--text);
      border-radius:12px;
      padding:10px 12px;
      font-weight:650;
      font-size:13px;
      cursor:pointer;
      box-shadow: 0 6px 18px rgba(0,0,0,.22);
      transition: transform 0.15s ease, box-shadow 0.15s ease, background 0.15s ease;
    }
    button:hover{
      background: linear-gradient(180deg, rgba(255,255,255,.09), rgba(255,255,255,.05));
      box-shadow: 0 8px 20px rgba(0,0,0,.28);
    }
    button:focus-visible{outline:2px solid var(--focus); outline-offset:2px}
    button:active{transform:translateY(1px);box-shadow: 0 4px 12px rgba(0,0,0,.2)}
    .seg{display:flex;background: rgba(255,255,255,.03);border:1px solid var(--border);border-radius:14px;padding:4px;gap:4px}
    .seg button{padding:8px 10px;border-radius:10px;border:0;box-shadow:none;background:transparent;color:var(--muted);font-weight:750}
    .seg button[aria-pressed="true"]{background: linear-gradient(180deg, rgba(122,167,255,.25), rgba(122,167,255,.12));color:var(--text)}
    .grid{display:grid;grid-template-columns:1fr;gap:12px}
    @media (min-width: 860px){
      .grid{grid-template-columns: 1.25fr .75fr;gap:14px}
      .title h1{font-size:20px}
    }
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .inner{padding:14px}
    .now{display:grid;grid-template-columns:1fr;gap:10px}
    @media (min-width: 520px){.now{grid-template-columns: 1.1fr .9fr;align-items:stretch}}
    .big{
      display:flex;flex-direction:column;gap:8px;padding:14px;border-radius:16px;
      background: linear-gradient(180deg, rgba(122,167,255,.18), rgba(122,167,255,.06));
      border:1px solid rgba(122,167,255,.25);
    }
    .big .label{color:var(--muted);font-size:12px;font-weight:700;letter-spacing:.2px}
    .big .price{font-size:40px;font-weight:900;letter-spacing:-.6px;line-height:1.05;display:flex;align-items:baseline;gap:10px;flex-wrap:wrap}
    .big .unit{font-size:14px;font-weight:800;color:var(--muted);letter-spacing:.2px}
    .trend{
      display:inline-flex;align-items:center;gap:8px;border:1px solid var(--border);
      background: rgba(0,0,0,.18);padding:8px 10px;border-radius:12px;width:max-content;
      font-weight:800;font-size:12px;color:var(--muted);
    }
    .trend b{color:var(--text)}
    .trend .dot{width:10px;height:10px;border-radius:999px;background: var(--muted);box-shadow: 0 0 0 4px rgba(255,255,255,.05)}
    .meta{display:flex;flex-direction:column;gap:10px;padding:14px;border-radius:16px;background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));border:1px solid var(--border)}
    .row{display:flex;justify-content:space-between;align-items:baseline;gap:10px}
    .row .k{color:var(--muted);font-size:12px;font-weight:750}
    .row .v{font-family:var(--mono);font-size:12px;font-weight:750}
    .chartWrap{padding:12px;border-radius:16px;background: linear-gradient(180deg, rgba(0,0,0,.22), rgba(0,0,0,.10));border:1px solid var(--border);position:relative}
    .chartHead{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:8px;flex-wrap:wrap}
    .chartHead h2{margin:0;font-size:14px;font-weight:850;letter-spacing:.2px}
    .status{display:flex;align-items:center;gap:10px;padding:8px 10px;border-radius:12px;border:1px solid var(--border);background: rgba(0,0,0,.16);width:max-content}
    .spinner{
      width:14px;height:14px;border-radius:999px;
      border:2px solid rgba(255,255,255,.25);
      border-top-color: rgba(122,167,255,.9);
      border-right-color: rgba(155,125,255,.7);
      animation: spin 0.8s cubic-bezier(0.68, -0.55, 0.265, 1.55) infinite;
    }
    @keyframes spin{to{transform:rotate(360deg)}}
    .svgBox{width:100%;height:240px}
    @media (min-width: 520px){.svgBox{height:300px}}
    .legend{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px;color:var(--muted);font-size:12px;font-weight:750}
    .legend .item{display:flex;gap:8px;align-items:center}
    .legend .line{width:20px;height:2px;background: var(--accent);border-radius:999px}
    .legend .mark{width:10px;height:10px;border-radius:999px;background: var(--accent2)}
    .list h2{margin:0 0 10px;font-size:14px;font-weight:850}
    .list .cols{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .mini{background: rgba(0,0,0,.18);border:1px solid var(--border);border-radius:16px;padding:12px;overflow:hidden}
    .mini h3{margin:0 0 8px;font-size:12px;color:var(--muted);font-weight:900;letter-spacing:.35px;text-transform:uppercase}
    .mini ul{margin:0;padding:0;list-style:none;display:flex;flex-direction:column;gap:8px}
    .mini li{display:flex;align-items:baseline;justify-content:space-between;gap:10px;padding-bottom:8px;border-bottom:1px dashed rgba(255,255,255,.09)}
    .mini li:last-child{border-bottom:0;padding-bottom:0}
    .t{font-family:var(--mono);font-size:12px;color:var(--muted);font-weight:750}
    .p{font-family:var(--mono);font-size:12px;font-weight:900}
    .p.good{color:var(--ok)} .p.bad{color:var(--bad)} .p.mid{color:var(--warn)}
    .heat{display:flex;flex-direction:column;gap:10px}
    .heatHead{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
    .heatHead h2{margin:0;font-size:14px;font-weight:850}
    .heatHead .hint{color:var(--muted);font-size:12px;font-weight:750}
    .tiles{display:flex;flex-direction:column;gap:6px}
    .tile{
      border-radius:12px;border:1px solid var(--border);padding:12px 16px;background: rgba(0,0,0,.16);
      min-width:0;display:flex;flex-direction:row;justify-content:flex-start;align-items:center;gap:16px;
      opacity:0;
      animation: fadeIn 0.3s ease-out forwards;
      transition: transform 0.15s ease, box-shadow 0.15s ease;
    }
    .tile:hover{
      transform: translateX(4px);
      box-shadow: 0 2px 8px rgba(0,0,0,.25);
    }
    @keyframes fadeIn{
      from{opacity:0;transform:translateY(8px)}
      to{opacity:1;transform:translateY(0)}
    }
    .tile .time{font-family:var(--mono);font-size:14px;font-weight:800;color:rgba(232,238,252,.95);white-space:nowrap;min-width:140px}
    .tile .val{font-family:var(--mono);font-size:16px;font-weight:950;display:flex;align-items:baseline;gap:6px;min-width:0;white-space:nowrap;margin-left:auto}
    .tile .val small{font-size:11px;font-weight:850;color:rgba(232,238,252,.75);white-space:nowrap}
    .tile[aria-current="true"]{outline:2px solid rgba(122,167,255,.7);box-shadow: 0 0 0 6px rgba(122,167,255,.15)}
    .foot{margin-top:12px;color:var(--muted);font-size:12px;line-height:1.4;display:flex;flex-wrap:wrap;gap:10px;justify-content:space-between;align-items:center}
    .toast{
      position:fixed;left:50%;bottom:18px;transform:translateX(-50%);
      background: rgba(10,18,35,.95);border:1px solid var(--border);box-shadow: var(--shadow);
      color:var(--text);padding:12px 16px;border-radius:14px;font-size:13px;font-weight:750;
      display:none;max-width:min(540px, calc(100vw - 28px));
      backdrop-filter: blur(10px);
      animation: slideUp 0.3s ease-out;
    }
    .toast.show{display:block}
    .toast.success{border-color:rgba(83,209,138,.4);background:rgba(10,18,35,.95)}
    .toast.error{border-color:rgba(255,92,122,.4);background:rgba(10,18,35,.95)}
    .toast.warning{border-color:rgba(255,209,102,.4);background:rgba(10,18,35,.95)}
    @keyframes slideUp{
      from{opacity:0;transform:translate(-50%, 20px)}
      to{opacity:1;transform:translate(-50%, 0)}
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="title">
        <h1>P√∂rssis√§hk√∂</h1>
      </div>

      <div class="actions">
        <div class="seg" role="group" aria-label="N√§kym√§">
          <button data-mode="future" aria-pressed="true">Tulevat</button>
          <button data-mode="past" aria-pressed="false">Menneet</button>
        </div>
        <div class="seg" role="group" aria-label="Aikav√§li">
          <button data-range="6"  aria-pressed="false">6h</button>
          <button data-range="12" aria-pressed="false">12h</button>
          <button data-range="24" aria-pressed="true">24h</button>
        </div>
        <button id="refreshBtn" title="P√§ivit√§">P√§ivit√§</button>
      </div>
    </header>

    <div class="grid">
      <section class="card">
        <div class="inner">
          <div class="now">
            <div class="big">
              <div class="label" id="nowLabel">Seuraava hinta (l√§hin vartti)</div>
              <div class="price">
                <span id="nowPrice">‚Äî</span>
                <span class="unit">snt / kWh</span>
              </div>
              <div class="trend" id="trendPill" aria-live="polite">
                <span class="dot" id="trendDot"></span>
                <span id="trendText">Haetaan dataa‚Ä¶</span>
              </div>
            </div>

            <div class="meta">
              <div class="row">
                <div class="k">N√§kym√§</div>
                <div class="v" id="modeLabel">Tulevat</div>
              </div>
              <div class="row">
                <div class="k">Aikav√§li</div>
                <div class="v" id="rangeLabel">24h</div>
              </div>
              <div class="row">
                <div class="k">Min / Max</div>
                <div class="v"><span id="minVal">‚Äî</span> / <span id="maxVal">‚Äî</span></div>
              </div>
              <div class="row">
                <div class="k">Keskiarvo</div>
                <div class="v" id="avgVal">‚Äî</div>
              </div>
              <div class="row">
                <div class="k">Viimeisin p√§ivitys</div>
                <div class="v" id="updatedAt">‚Äî</div>
              </div>
            </div>
          </div>

          <div style="height:12px"></div>

          <div class="chartWrap">
            <div class="chartHead">
              <h2 id="chartTitle">Tulevat hinnat</h2>
              <div class="status" id="statusBox">
                <span class="spinner" id="spin" aria-hidden="true"></span>
                <span id="statusText">Ladataan‚Ä¶</span>
              </div>
            </div>

            <svg class="svgBox" id="chart" viewBox="0 0 1000 320" preserveAspectRatio="none" role="img" aria-label="Hintak√§yr√§"></svg>
            <div id="chartTooltip" style="display:none;position:fixed;background:rgba(10,18,35,.97);border:1px solid rgba(122,167,255,.4);border-radius:12px;padding:12px 16px;font-size:14px;pointer-events:none;z-index:1000;backdrop-filter:blur(12px);box-shadow:0 6px 20px rgba(0,0,0,.5);min-width:160px"></div>
          </div>

          <div class="foot">
            <div>Huom: huomisen hinnat n√§kyv√§t yleens√§ vasta kun ne ovat julkaistu (tyypillisesti iltap√§iv√§ll√§).</div>
            <div>
              <span class="t">L√§hde:</span> <span class="t" id="sourceLabel">‚Äî</span>
              <span class="t" id="rateLimitInfo" style="margin-left:8px;color:var(--muted)"></span>
            </div>
          </div>
        </div>
      </section>

      <aside class="card">
        <div class="inner list">
          <div class="heat">
            <div class="heatHead">
              <h2>Tuntilista</h2>
              <div class="hint">V√§ri = suhteellinen hinta</div>
            </div>
            <div class="tiles" id="tiles" aria-label="Tuntikohtaiset hinnat"></div>
          </div>

          <div style="height:20px"></div>

          <h2>√Ñ√§riarvot valitulta aikav√§lilt√§</h2>
          <div class="cols">
            <div class="mini">
              <h3>Halvimmat</h3>
              <ul id="cheapList"></ul>
            </div>
            <div class="mini">
              <h3>Kalleimmat</h3>
              <ul id="expList"></ul>
            </div>
          </div>
        </div>
      </aside>
    </div>
  </div>

  <div class="toast" id="toast" role="status" aria-live="polite"></div>

  <script>
    console.log('üîß DEBUG: K√§ynnistys - width:', window.innerWidth, 'height:', window.innerHeight);
    window.addEventListener('resize', () => {
      console.log('üîß DEBUG: Resize - width:', window.innerWidth);
    });

    // API docs: v2/latest-prices.json and v2/price.json
    const API_ENDPOINT = 'https://api.porssisahko.net/v2/latest-prices.json';
    const LOCAL_ENDPOINT = './data/latest-prices.json'; // generated by GitHub Action

    const el = (id) => document.getElementById(id);

    const ui = {
      nowLabel: el('nowLabel'),
      nowPrice: el('nowPrice'),
      trendText: el('trendText'),
      trendDot: el('trendDot'),
      modeLabel: el('modeLabel'),
      rangeLabel: el('rangeLabel'),
      chartTitle: el('chartTitle'),
      minVal: el('minVal'),
      maxVal: el('maxVal'),
      avgVal: el('avgVal'),
      updatedAt: el('updatedAt'),
      cheapList: el('cheapList'),
      expList: el('expList'),
      tiles: el('tiles'),
      chart: el('chart'),
      chartTooltip: el('chartTooltip'),
      statusText: el('statusText'),
      spin: el('spin'),
      toast: el('toast'),
      sourceLabel: el('sourceLabel'),
      rateLimitInfo: el('rateLimitInfo')
    };

    let state = {
      all: [],
      mode: 'future',    // 'future' | 'past'
      rangeHours: 24,
      lastUpdated: null,
      rateLimit: null
    };

    function showToast(msg, type = 'default'){
      console.log('üîß DEBUG: Toast:', msg, 'type:', type);
      ui.toast.textContent = msg;
      ui.toast.className = 'toast show';
      
      // Lis√§t√§√§n tyyppi-luokka
      if(type === 'success') ui.toast.classList.add('success');
      else if(type === 'error') ui.toast.classList.add('error');
      else if(type === 'warning') ui.toast.classList.add('warning');
      
      clearTimeout(showToast._t);
      showToast._t = setTimeout(()=>ui.toast.classList.remove('show'), 4000);
    }

    function formatFiTime(d){
      const weekday = new Intl.DateTimeFormat('fi-FI', {weekday:'short'}).format(d);
      const day = d.getDate();
      const month = d.getMonth() + 1;
      const hour = String(d.getHours()).padStart(2, '0');
      const minute = String(d.getMinutes()).padStart(2, '0');
      return `${weekday} ${day}.${month}. klo ${hour}.${minute}`;
    }

    function quantile(sortedArr, q){
      if(!sortedArr.length) return 0;
      const pos = (sortedArr.length - 1) * q;
      const base = Math.floor(pos);
      const rest = pos - base;
      if(sortedArr[base + 1] === undefined) return sortedArr[base];
      return sortedArr[base] + rest * (sortedArr[base + 1] - sortedArr[base]);
    }

    function calcStats(entries){
      const vals = entries.map(x=>x.price);
      const min = Math.min(...vals);
      const max = Math.max(...vals);
      const avg = vals.reduce((a,b)=>a+b,0) / (vals.length || 1);
      const sorted = [...vals].sort((a,b)=>a-b);
      const q1 = quantile(sorted, 0.25);
      const q3 = quantile(sorted, 0.75);
      return {min, max, avg, q1, q3};
    }

    function formatPrice(p){ return (Math.round(p * 100) / 100).toFixed(2); }
    
    function formatPriceChart(p){ return Math.round(p).toString(); }

    function tileBg(p, q1, q3){
      if(p <= q1) return 'rgba(83, 209, 138, .22)';
      if(p >= q3) return 'rgba(255, 92, 122, .22)';
      return 'rgba(255, 209, 102, .18)';
    }
    function tileBorder(p, q1, q3){
      if(p <= q1) return 'rgb(83, 209, 138)';  // Kirkas vihre√§
      if(p >= q3) return 'rgb(255, 92, 122)';  // Kirkas punainen
      return 'rgb(255, 209, 102)';             // Kirkas keltainen
    }
    function priceClass(p, q1, q3){
      if(p <= q1) return 'good';
      if(p >= q3) return 'bad';
      return 'mid';
    }

    function parsePrices(raw){
      console.log('üîß DEBUG: Validoidaan data');
      
      // Validoi ett√§ raw on objekti ja prices on array
      if(!raw || typeof raw !== 'object' || !Array.isArray(raw.prices)){
        console.error('üîß DEBUG: Virheellinen data-rakenne', raw);
        return [];
      }
      
      const arr = raw.prices;
      const parsed = arr.map(x => {
        // Validoi ett√§ price on numero
        const price = Number(x.price);
        if(!Number.isFinite(price)){
          console.warn('üîß DEBUG: Virheellinen hinta:', x);
          return null;
        }
        
        // Validoi p√§iv√§m√§√§r√§t
        const start = new Date(x.startDate);
        const end = new Date(x.endDate);
        if(isNaN(start) || isNaN(end)){
          console.warn('üîß DEBUG: Virheellinen p√§iv√§m√§√§r√§:', x);
          return null;
        }
        
        return {
          price: price,
          start: start,
          end: end,
          startIso: x.startDate,
          endIso: x.endDate
        };
      }).filter(x => x !== null);
      
      console.log('üîß DEBUG: Validoitu', parsed.length, 'hintaa');
      return parsed;
    }

    function aggregateToHours(quarters){
      console.log('üîß DEBUG: Aggregoidaan', quarters.length, 'varttia tunneiksi');
      const hourMap = new Map();
      
      for(const q of quarters){
        const hourKey = new Date(q.start.getFullYear(), q.start.getMonth(), q.start.getDate(), q.start.getHours()).toISOString();
        
        if(!hourMap.has(hourKey)){
          hourMap.set(hourKey, {
            start: new Date(q.start.getFullYear(), q.start.getMonth(), q.start.getDate(), q.start.getHours()),
            prices: []
          });
        }
        hourMap.get(hourKey).prices.push(q.price);
      }
      
      const hours = [];
      for(const [key, data] of hourMap.entries()){
        const avgPrice = data.prices.reduce((a,b)=>a+b,0) / data.prices.length;
        const endTime = new Date(data.start.getTime() + 3600000);
        hours.push({
          price: avgPrice,
          start: data.start,
          end: endTime,
          startIso: data.start.toISOString(),
          endIso: endTime.toISOString()
        });
      }
      
      console.log('üîß DEBUG: Aggregoitu', hours.length, 'tuntia');
      return hours.sort((a,b)=>a.start-b.start);
    }

    function nearestQuarterFromNow(entries){
      const now = new Date();
      // "future": first entry with end > now (so current or next). We prefer next start >= now, but allow "current" as nearest.
      const futureStarts = entries.filter(e => e.start >= now).sort((a,b)=>a.start-b.start);
      if(futureStarts.length) return futureStarts[0];
      // fallback: current
      const current = entries.find(e => e.start <= now && e.end > now);
      return current || null;
    }

    function sliceWindow(entries, mode, rangeHours){
      const now = new Date();
      const ms = rangeHours * 3600 * 1000;

      if(mode === 'future'){
        const to = new Date(now.getTime() + ms);
        return entries.filter(e => e.start >= now && e.start <= to).sort((a,b)=>a.start-b.start);
      } else {
        const from = new Date(now.getTime() - ms);
        return entries.filter(e => e.start >= from && e.start <= now).sort((a,b)=>a.start-b.start);
      }
    }

    function drawChart(entries){
      const W=1000,H=320,padL=54,padR=18,padT=18,padB=46;
      const w=W-padL-padR,h=H-padT-padB;

      if(entries.length < 2){
        ui.chart.innerHTML = `
          <text x="50%" y="50%" fill="rgba(255,255,255,.60)" font-size="14" text-anchor="middle">
            Ei riitt√§v√§sti dataa t√§h√§n n√§kym√§√§n.
          </text>`;
        return;
      }

      const vals = entries.map(e=>e.price);
      const min = Math.min(...vals);
      const max = Math.max(...vals);
      const span = (max-min) || 1;

      const x = (i)=> padL + (i/(entries.length-1))*w;
      const y = (v)=> padT + (1-(v-min)/span)*h;

      // Grid
      const grid=[];
      const stepsY=4;
      for(let i=0;i<=stepsY;i++){
        const yy=padT+(i/stepsY)*h;
        grid.push(`<line x1="${padL}" y1="${yy}" x2="${W-padR}" y2="${yy}" stroke="rgba(255,255,255,.07)" stroke-width="1" />`);
      }
      const stepsX=6;
      for(let i=0;i<=stepsX;i++){
        const xx=padL+(i/stepsX)*w;
        grid.push(`<line x1="${xx}" y1="${padT}" x2="${xx}" y2="${H-padB}" stroke="rgba(255,255,255,.06)" stroke-width="1" />`);
      }

      // Path
      let d='';
      entries.forEach((e,i)=>{
        const xx=x(i), yy=y(e.price);
        d += (i===0 ? `M ${xx} ${yy}` : ` L ${xx} ${yy}`);
      });

      // "now" marker line (current time position within window, not tied to a data point)
      const now = new Date();
      const startT = entries[0].start.getTime();
      const endT = entries[entries.length-1].start.getTime();
      let nowMarkup = '';
      if(now.getTime() >= startT && now.getTime() <= endT){
        const t = (now.getTime()-startT)/(endT-startT || 1);
        const nx = padL + t*w;
        // N√§kyv√§mpi nykyhetki-viiva + label
        nowMarkup = `
          <line x1="${nx}" y1="${padT}" x2="${nx}" y2="${H-padB}" stroke="rgba(155,125,255,.75)" stroke-width="3" stroke-dasharray="6,4" />
          <circle cx="${nx}" cy="${padT-5}" r="5" fill="rgba(155,125,255,.9)" />
          <text x="${nx}" y="${padT-10}" fill="rgba(155,125,255,.95)" font-size="11" text-anchor="middle" font-weight="800">NYT</text>
        `;
        console.log('üîß DEBUG: Nykyhetki n√§kyy graafissa');
      } else {
        console.log('üîß DEBUG: Nykyhetki ei ole t√§ss√§ aikaikkunassa');
      }

      const startLbl = formatFiTime(entries[0].start);
      const endLbl = formatFiTime(entries[entries.length-1].start);

      ui.chart.innerHTML = `
        <rect x="0" y="0" width="${W}" height="${H}" fill="transparent" />
        ${grid.join('')}
        <path d="${d}" fill="none" stroke="rgba(122,167,255,.95)" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
        ${nowMarkup}
        <line x1="${padL}" y1="${padT}" x2="${padL}" y2="${H-padB}" stroke="rgba(255,255,255,.10)" stroke-width="1.5" />
        <line x1="${padL}" y1="${H-padB}" x2="${W-padR}" y2="${H-padB}" stroke="rgba(255,255,255,.10)" stroke-width="1.5" />
        <text x="${padL}" y="${H-18}" fill="rgb(255,255,255)" font-size="17" font-weight="700" font-family="${getComputedStyle(document.documentElement).getPropertyValue('--mono')}">${startLbl}</text>
        <text x="${W-padR}" y="${H-18}" fill="rgb(255,255,255)" font-size="17" font-weight="700" text-anchor="end" font-family="${getComputedStyle(document.documentElement).getPropertyValue('--mono')}">${endLbl}</text>
        <text x="${padL-10}" y="${y(max)+5}" fill="rgb(255,255,255)" font-size="20" font-weight="900" text-anchor="end" font-family="${getComputedStyle(document.documentElement).getPropertyValue('--mono')}">${formatPriceChart(max)}</text>
        <text x="${padL-10}" y="${y(min)+5}" fill="rgb(255,255,255)" font-size="20" font-weight="900" text-anchor="end" font-family="${getComputedStyle(document.documentElement).getPropertyValue('--mono')}">${formatPriceChart(min)}</text>
      `;
      
      // Lis√§t√§√§n interaktiivisuus - tooltip n√§ytt√§√§ hinnan koskettaessa/hoverissa
      const chartRect = ui.chart.getBoundingClientRect();
      
      const showTooltipForPoint = (clientX, clientY) => {
        const svgX = ((clientX - chartRect.left) / chartRect.width) * W;
        
        if(svgX < padL || svgX > W - padR) {
          ui.chartTooltip.style.display = 'none';
          return;
        }
        
        // Laske l√§hin datapiste
        const dataIndex = Math.round(((svgX - padL) / w) * (entries.length - 1));
        if(dataIndex < 0 || dataIndex >= entries.length) {
          ui.chartTooltip.style.display = 'none';
          return;
        }
        
        const point = entries[dataIndex];
        ui.chartTooltip.innerHTML = `
          <div style="font-weight:800;color:var(--accent);margin-bottom:6px;font-size:16px">${formatPrice(point.price)} snt/kWh</div>
          <div style="font-size:13px;color:var(--muted)">${formatFiTime(point.start)}</div>
        `;
        ui.chartTooltip.style.display = 'block';
        
        // Laske tooltip-koko ja varmista ett√§ pysyy ruudulla
        const tooltipRect = ui.chartTooltip.getBoundingClientRect();
        const tooltipWidth = tooltipRect.width || 150;
        const tooltipHeight = tooltipRect.height || 60;
        
        // Sijoita tooltip l√§hemm√§ksi sormea - vasemmalle puolelle jos mahtuu, muuten oikealle
        let left = clientX - tooltipWidth - 15;
        if(left < 10) {
          left = clientX + 15;
        }
        
        // Varmista ett√§ tooltip ei mene oikean reunan yli
        const maxLeft = window.innerWidth - tooltipWidth - 10;
        if(left > maxLeft) {
          left = maxLeft;
        }
        
        // Sijoita tooltip hieman kosketuspaikan yl√§puolelle
        let top = clientY - tooltipHeight - 15;
        if(top < 10) {
          top = clientY + 20; // Jos ei mahdu yl√§puolelle, laita alapuolelle
        }
        
        ui.chartTooltip.style.left = `${left}px`;
        ui.chartTooltip.style.top = `${top}px`;
        ui.chartTooltip.style.zIndex = '1000';
      };
      
      ui.chart.addEventListener('mousemove', (e) => showTooltipForPoint(e.clientX, e.clientY));
      ui.chart.addEventListener('touchmove', (e) => {
        e.preventDefault();
        const touch = e.touches[0];
        showTooltipForPoint(touch.clientX, touch.clientY);
      });
      ui.chart.addEventListener('mouseleave', () => ui.chartTooltip.style.display = 'none');
      ui.chart.addEventListener('touchend', () => ui.chartTooltip.style.display = 'none');
      
      console.log('üîß DEBUG: Graafi-interaktiivisuus lis√§tty');
    }

    function render(){
      if(!state.all.length) return;

      const window = sliceWindow(state.all, state.mode, state.rangeHours);
      ui.modeLabel.textContent = state.mode === 'future' ? 'Tulevat' : 'Menneet';
      ui.chartTitle.textContent = state.mode === 'future' ? 'Tulevat hinnat' : 'Menneet hinnat';
      ui.rangeLabel.textContent = `${state.rangeHours}h`;

      if(!window.length){
        ui.nowLabel.textContent = state.mode === 'future' ? 'Seuraava hinta' : 'Hinta viime vartilta';
        ui.nowPrice.textContent = '‚Äî';
        ui.trendText.textContent = state.mode === 'future'
          ? 'Tulevia hintoja ei ole saatavilla t√§ss√§ datassa (huomisen hinnat eiv√§t ehk√§ viel√§ ole julkaistu).'
          : 'Menneit√§ hintoja ei l√∂ytynyt t√§lle ikkunalle.';
        ui.trendDot.style.background = 'rgba(255,255,255,.35)';
        ui.minVal.textContent = ui.maxVal.textContent = ui.avgVal.textContent = '‚Äî';
        ui.tiles.innerHTML = '';
        ui.cheapList.innerHTML = '';
        ui.expList.innerHTML = '';
        drawChart(window);
        return;
      }

      const stats = calcStats(window);
      ui.minVal.textContent = formatPrice(stats.min);
      ui.maxVal.textContent = formatPrice(stats.max);
      ui.avgVal.textContent = formatPrice(stats.avg);

      // Card main value
      if(state.mode === 'future'){
        const next = nearestQuarterFromNow(state.all);
        if(next){
          ui.nowLabel.textContent = 'Seuraava hinta (l√§hin vartti)';
          ui.nowPrice.textContent = formatPrice(next.price);
          // Turvallinen rakentaminen ilman innerHTML
          const time = document.createElement('b');
          time.textContent = formatFiTime(next.start);
          ui.trendText.textContent = '';
          ui.trendText.appendChild(time);
          ui.trendText.appendChild(document.createTextNode(' ¬∑ alkaa'));
          ui.trendDot.style.background = 'var(--accent2)';
          console.log('üîß DEBUG: Seuraava hinta asetettu turvallisesti');
        } else {
          ui.nowLabel.textContent = 'Seuraava hinta';
          ui.nowPrice.textContent = '‚Äî';
          ui.trendText.textContent = 'Seuraavaa varttia ei l√∂ytynyt datasta.';
          ui.trendDot.style.background = 'rgba(255,255,255,.35)';
        }
      } else {
        const last = window[window.length-1];
        ui.nowLabel.textContent = 'Hinta (viimeisin vartti ikkunassa)';
        ui.nowPrice.textContent = formatPrice(last.price);
        // Turvallinen rakentaminen
        const timeStart = document.createElement('b');
        timeStart.textContent = formatFiTime(last.start);
        ui.trendText.textContent = '';
        ui.trendText.appendChild(timeStart);
        ui.trendText.appendChild(document.createTextNode(' ¬∑ p√§√§ttyy ' + formatFiTime(last.end)));
        ui.trendDot.style.background = 'var(--accent)';
        console.log('üîß DEBUG: Viimeisin hinta asetettu turvallisesti');
      }

      // Top lists - turvalliset DOM-elementit
      const sorted = [...window].sort((a,b)=>a.price-b.price);
      const cheapest = sorted.slice(0, 8);
      const expensive = sorted.slice(-8).reverse();
      
      const createListItem = (e, cls) => {
        const li = document.createElement('li');
        const timeSpan = document.createElement('span');
        timeSpan.className = 't';
        timeSpan.textContent = formatFiTime(e.start);
        const priceSpan = document.createElement('span');
        priceSpan.className = `p ${cls}`;
        priceSpan.textContent = formatPrice(e.price);
        li.appendChild(timeSpan);
        li.appendChild(priceSpan);
        return li;
      };
      
      ui.cheapList.innerHTML = '';
      cheapest.forEach(e => {
        ui.cheapList.appendChild(createListItem(e, priceClass(e.price, stats.q1, stats.q3)));
      });
      
      ui.expList.innerHTML = '';
      expensive.forEach(e => {
        ui.expList.appendChild(createListItem(e, priceClass(e.price, stats.q1, stats.q3)));
      });
      
      console.log('üîß DEBUG: Listat luotu turvallisesti');

      // Tiles - aggregoi tunteiksi
      const hourlyData = aggregateToHours(window);
      const hourlyStats = calcStats(hourlyData);
      console.log('üîß DEBUG: Render√∂id√§√§n', hourlyData.length, 'tuntia tilesiin');
      
      ui.tiles.innerHTML = '';
      for(let i = 0; i < hourlyData.length; i++){
        const e = hourlyData[i];
        const tile = document.createElement('button');
        tile.type = 'button';
        tile.className = 'tile';
        tile.style.animationDelay = `${i * 0.02}s`; // Staggered animation
        tile.setAttribute('aria-label', `${formatFiTime(e.start)}: ${formatPrice(e.price)} snt / kWh`);
        
        // Turvallinen DOM-rakentaminen
        const timeDiv = document.createElement('div');
        timeDiv.className = 'time';
        timeDiv.textContent = formatFiTime(e.start);
        
        const valDiv = document.createElement('div');
        valDiv.className = 'val';
        // Lis√§√§ v√§ri hintatekstiin
        valDiv.style.color = tileBorder(e.price, hourlyStats.q1, hourlyStats.q3);
        valDiv.textContent = formatPrice(e.price) + ' ';
        
        const smallEl = document.createElement('small');
        smallEl.textContent = 'snt/kWh';
        valDiv.appendChild(smallEl);
        
        tile.appendChild(timeDiv);
        tile.appendChild(valDiv);
        
        tile.addEventListener('click', () => showToast(`${formatFiTime(e.start)} ¬∑ ${formatPrice(e.price)} snt/kWh`));
        ui.tiles.appendChild(tile);
      }
      console.log('üîß DEBUG: Tiles luotu turvallisesti');

      drawChart(window);
    }

    async function fetchJson(url){
      console.log('üîß DEBUG: Haetaan:', url);
      const res = await fetch(url, { cache: 'no-store' });
      
      // Lue rate limit -headerit jos saatavilla
      const rateLimit = res.headers.get('X-RateLimit-Limit');
      const rateRemaining = res.headers.get('X-RateLimit-Remaining');
      const rateReset = res.headers.get('X-RateLimit-Reset');
      
      if(rateLimit || rateRemaining || rateReset){
        console.log('üîß DEBUG: API Rate Limit:');
        console.log('  - Limit:', rateLimit || 'N/A');
        console.log('  - Remaining:', rateRemaining || 'N/A');
        console.log('  - Reset:', rateReset ? new Date(parseInt(rateReset) * 1000) : 'N/A');
        
        // Tallenna state-objektiin
        state.rateLimit = {
          limit: rateLimit ? parseInt(rateLimit) : null,
          remaining: rateRemaining ? parseInt(rateRemaining) : null,
          reset: rateReset ? new Date(parseInt(rateReset) * 1000) : null
        };
        
        // Varoitus jos l√§hell√§ rajaa
        if(rateRemaining && parseInt(rateRemaining) < 10){
          console.warn('‚ö†Ô∏è DEBUG: API rate limit l√§hes t√§ynn√§! J√§ljell√§:', rateRemaining);
        }
      } else {
        console.log('üîß DEBUG: Ei rate limit -headereja (normaalia paikalliselle tiedostolle)');
      }
      
      if(!res.ok) {
        console.error('üîß DEBUG: HTTP virhe:', res.status, res.statusText);
        throw new Error(`HTTP ${res.status}`);
      }
      
      return res.json();
    }

    async function loadData(force){
      setLoading(true, 'Haetaan‚Ä¶');
      console.log('üîß DEBUG: loadData aloitus, force:', force);

      // 1) Prefer local file (works on GitHub Pages always)
      try{
        const local = await fetchJson(LOCAL_ENDPOINT + (force ? `?t=${Date.now()}` : ''));
        const parsed = parsePrices(local);
        if(parsed.length){
          state.all = parsed.sort((a,b)=>a.start-b.start);
          state.lastUpdated = new Date(local.generatedAt || Date.now());
          ui.updatedAt.textContent = formatFiTime(state.lastUpdated);
          ui.sourceLabel.textContent = 'local (/data/latest-prices.json)';
          setLoading(false, 'Valmis');
          console.log('üîß DEBUG: Data ladattu paikallisesta tiedostosta, rivej√§:', parsed.length);
          showToast(`‚úì Data ladattu onnistuneesti (${parsed.length} hintaa)`, 'success');
          render();
          return;
        }
      } catch (err) {
        console.log('üîß DEBUG: Paikallinen tiedosto ei saatavilla:', err.message);
      }

      // 2) Try direct API (may fail due to CORS in browser)
      try{
        const api = await fetchJson(API_ENDPOINT);
        const parsed = parsePrices(api);
        if(!parsed.length) throw new Error('Tyhj√§ data');
        state.all = parsed.sort((a,b)=>a.start-b.start);
        state.lastUpdated = new Date();
        ui.updatedAt.textContent = formatFiTime(state.lastUpdated);
        ui.sourceLabel.textContent = 'API (direct)';
        setLoading(false, 'Valmis');
        console.log('üîß DEBUG: Data ladattu API:sta, rivej√§:', parsed.length);
        
        // N√§yt√§ rate limit info jos saatavilla
        if(state.rateLimit && state.rateLimit.remaining !== null){
          console.log('üìä API-pyynt√∂j√§ j√§ljell√§:', state.rateLimit.remaining);
          ui.rateLimitInfo.textContent = `(API: ${state.rateLimit.remaining}/${state.rateLimit.limit || '?'} j√§ljell√§)`;
          
          if(state.rateLimit.remaining < 10){
            showToast(`Varoitus: API-pyynt√∂j√§ j√§ljell√§ vain ${state.rateLimit.remaining}`, 'warning');
            ui.rateLimitInfo.style.color = 'var(--warn)';
          } else if(state.rateLimit.remaining < 5){
            ui.rateLimitInfo.style.color = 'var(--bad)';
          }
        } else {
          ui.rateLimitInfo.textContent = '';
        }
        
        render();
        return;
      } catch (err){
        console.error('üîß DEBUG: API-haku ep√§onnistui:', err);
        setLoading(false, 'Virhe');
        ui.sourceLabel.textContent = '‚Äî';
        
        // Tarkempi virheilmoitus
        let errorMsg = 'Datan haku ep√§onnistui';
        if(err.message.includes('CORS') || err.name === 'TypeError'){
          errorMsg += ' (CORS-esto). Ota GitHub Action k√§ytt√∂√∂n.';
        } else if(err.message.includes('429')){
          errorMsg += ' (API rate limit t√§ynn√§). Yrit√§ my√∂hemmin uudelleen.';
        } else {
          errorMsg += `: ${err.message}`;
        }
        
        showToast(errorMsg, 'error');
      }
    }

    function setLoading(isLoading, text){
      ui.statusText.textContent = text || (isLoading ? 'Ladataan‚Ä¶' : 'Valmis');
      ui.spin.style.display = isLoading ? 'inline-block' : 'none';
      // Piilotetaan status-box kun valmis
      const statusBox = document.getElementById('statusBox');
      if(statusBox){
        statusBox.style.display = isLoading ? 'flex' : 'none';
      }
      console.log('üîß DEBUG: Loading status:', isLoading, text);
    }

    // Buttons: mode
    document.querySelectorAll('[data-mode]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const m = btn.dataset.mode;
        state.mode = m;
        document.querySelectorAll('[data-mode]').forEach(b=>{
          b.setAttribute('aria-pressed', b.dataset.mode === m ? 'true' : 'false');
        });
        render();
      });
    });

    // Buttons: range
    document.querySelectorAll('[data-range]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const r = Number(btn.dataset.range);
        state.rangeHours = r;
        document.querySelectorAll('[data-range]').forEach(b=>{
          b.setAttribute('aria-pressed', Number(b.dataset.range) === r ? 'true' : 'false');
        });
        render();
      });
    });

    // Refresh
    el('refreshBtn').addEventListener('click', ()=>loadData(true));

    // Init
    loadData(false);
  </script>
</body>
</html>
