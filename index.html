<!doctype html>
<html lang="fi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>P√∂rssis√§hk√∂ ‚Äì Spot-hinnat (vartti)</title>
  <meta name="description" content="Mobiiliyst√§v√§llinen n√§kym√§ Suomen p√∂rssis√§hk√∂n varttihinnoille." />

  <!-- No robots (meta) -->
  <meta name="robots" content="noindex,nofollow,noarchive,nosnippet,noimageindex" />
  <meta name="googlebot" content="noindex,nofollow,noarchive,nosnippet,noimageindex" />
  <meta name="bingbot" content="noindex,nofollow,noarchive,nosnippet,noimageindex" />

  <meta name="theme-color" content="#0b1220" />

  <!-- No robots (best-effort script, runs ASAP) -->
  <script>
    (() => {
      try {
        const ua = (navigator.userAgent || "");
        const bot = /bot|crawler|spider|crawling|HeadlessChrome|Lighthouse|pagespeed|facebookexternalhit|Slackbot|Discordbot|TelegramBot|WhatsApp|Google-Read-Aloud/i;
        if (bot.test(ua)) {
          // Keep it empty for bots
          document.documentElement.innerHTML = "<head><meta name='robots' content='noindex,nofollow'></head><body></body>";
        }
      } catch (_) {}
    })();
  </script>

  <style>
    :root{
      --bg:#0b1220;
      --panel:#0f1a33;
      --text:#e8eefc;
      --muted:#aab7da;
      --border:rgba(255,255,255,.08);
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --ok:#53d18a;
      --warn:#ffd166;
      --bad:#ff5c7a;
      --accent:#7aa7ff;
      --accent2:#9b7dff;
      --focus: rgba(122,167,255,.35);
      --radius:18px;
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--font);
      background: radial-gradient(1200px 800px at 20% -10%, rgba(122,167,255,.18), transparent 60%),
                  radial-gradient(900px 600px at 90% 10%, rgba(155,125,255,.14), transparent 55%),
                  var(--bg);
      color:var(--text);
    }
    .wrap{max-width:1100px;margin:0 auto;padding:18px 14px 34px;}
    header{display:flex;align-items:flex-start;justify-content:space-between;gap:12px;margin:6px 0 14px;flex-wrap:wrap}
    .title{display:flex;flex-direction:column;gap:6px;min-width:0;flex:1 1 240px}
    .title h1{font-size:18px;margin:0;letter-spacing:.2px;font-weight:750}
    .title p{margin:0;color:var(--muted);font-size:13px;line-height:1.35}
    .actions{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end;align-items:center;min-width:0}
    button{
      -webkit-tap-highlight-color: transparent;
      border:1px solid var(--border);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      color:var(--text);
      border-radius:12px;
      padding:10px 12px;
      font-weight:650;
      font-size:13px;
      cursor:pointer;
      box-shadow: 0 6px 18px rgba(0,0,0,.22);
      white-space:nowrap;
      min-width:0;
    }
    button:focus-visible{outline:2px solid var(--focus); outline-offset:2px}
    button:active{transform:translateY(1px)}
    .seg{display:flex;background: rgba(255,255,255,.03);border:1px solid var(--border);border-radius:14px;padding:4px;gap:4px;overflow-x:auto;overflow-y:hidden;-webkit-overflow-scrolling:touch}
    .seg button{padding:8px 10px;border-radius:10px;border:0;box-shadow:none;background:transparent;color:var(--muted);font-weight:750;white-space:nowrap;flex-shrink:0}
    .seg button[aria-pressed="true"]{background: linear-gradient(180deg, rgba(122,167,255,.25), rgba(122,167,255,.12));color:var(--text)}
    .grid{display:grid;grid-template-columns:1fr;gap:12px;width:100%;min-width:0}
    @media (min-width: 860px){
      .grid{grid-template-columns: 1.25fr .75fr;gap:14px}
      .title h1{font-size:20px}
    }
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
      width:100%;
      min-width:0;
    }
    .card .inner{padding:14px;width:100%;min-width:0}
    .now{display:grid;grid-template-columns:1fr;gap:10px}
    @media (min-width: 520px){.now{grid-template-columns: 1.1fr .9fr;align-items:stretch}}
    .big{
      display:flex;flex-direction:column;gap:8px;padding:14px;border-radius:16px;
      background: linear-gradient(180deg, rgba(122,167,255,.18), rgba(122,167,255,.06));
      border:1px solid rgba(122,167,255,.25);
    }
    .big .label{color:var(--muted);font-size:12px;font-weight:700;letter-spacing:.2px}
    .big .price{font-size:40px;font-weight:900;letter-spacing:-.6px;line-height:1.05;display:flex;align-items:baseline;gap:10px;flex-wrap:wrap}
    .big .unit{font-size:14px;font-weight:800;color:var(--muted);letter-spacing:.2px}
    .trend{
      display:inline-flex;align-items:center;gap:8px;border:1px solid var(--border);
      background: rgba(0,0,0,.18);padding:8px 10px;border-radius:12px;width:max-content;
      font-weight:800;font-size:12px;color:var(--muted);
    }
    .trend b{color:var(--text)}
    .trend .dot{width:10px;height:10px;border-radius:999px;background: var(--muted);box-shadow: 0 0 0 4px rgba(255,255,255,.05)}
    .meta{display:flex;flex-direction:column;gap:10px;padding:14px;border-radius:16px;background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));border:1px solid var(--border)}
    .row{display:flex;justify-content:space-between;align-items:baseline;gap:10px}
    .row .k{color:var(--muted);font-size:12px;font-weight:750}
    .row .v{font-family:var(--mono);font-size:12px;font-weight:750}
    .chartWrap{padding:12px;border-radius:16px;background: linear-gradient(180deg, rgba(0,0,0,.22), rgba(0,0,0,.10));border:1px solid var(--border)}
    .chartHead{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:8px;flex-wrap:wrap}
    .chartHead h2{margin:0;font-size:14px;font-weight:850;letter-spacing:.2px}
    .status{display:flex;align-items:center;gap:10px;padding:8px 10px;border-radius:12px;border:1px solid var(--border);background: rgba(0,0,0,.16);width:max-content}
    .spinner{width:14px;height:14px;border-radius:999px;border:2px solid rgba(255,255,255,.25);border-top-color: rgba(255,255,255,.75);animation: spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .svgBox{width:100%;height:240px}
    @media (min-width: 520px){.svgBox{height:300px}}
    .legend{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px;color:var(--muted);font-size:12px;font-weight:750}
    .legend .item{display:flex;gap:8px;align-items:center}
    .legend .line{width:20px;height:2px;background: var(--accent);border-radius:999px}
    .legend .mark{width:10px;height:10px;border-radius:999px;background: var(--accent2)}
    .list h2{margin:0 0 10px;font-size:14px;font-weight:850}
    .list .cols{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .mini{background: rgba(0,0,0,.18);border:1px solid var(--border);border-radius:16px;padding:12px;overflow:hidden}
    .mini h3{margin:0 0 8px;font-size:12px;color:var(--muted);font-weight:900;letter-spacing:.35px;text-transform:uppercase}
    .mini ul{margin:0;padding:0;list-style:none;display:flex;flex-direction:column;gap:8px}
    .mini li{display:flex;align-items:baseline;justify-content:space-between;gap:10px;padding-bottom:8px;border-bottom:1px dashed rgba(255,255,255,.09)}
    .mini li:last-child{border-bottom:0;padding-bottom:0}
    .t{font-family:var(--mono);font-size:12px;color:var(--muted);font-weight:750}
    .p{font-family:var(--mono);font-size:12px;font-weight:900}
    .p.good{color:var(--ok)} .p.bad{color:var(--bad)} .p.mid{color:var(--warn)}
    .heat{display:flex;flex-direction:column;gap:10px;width:100%;min-width:0}
    .heatHead{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
    .heatHead h2{margin:0;font-size:14px;font-weight:850}
    .heatHead .hint{color:var(--muted);font-size:12px;font-weight:750}
    .tiles{display:grid;grid-template-columns: repeat(4, 1fr);gap:8px;width:100%;min-width:0}
    @media (min-width:520px){.tiles{grid-template-columns: repeat(6, 1fr)}}
    @media (min-width:860px){.tiles{grid-template-columns: repeat(8, 1fr)}}
    .tile{
      border-radius:14px;border:1px solid var(--border);padding:10px;background: rgba(0,0,0,.16);
      min-height:74px;min-width:0;display:flex;flex-direction:column;justify-content:space-between;gap:8px;
    }
    .tile .time{font-family:var(--mono);font-size:11px;font-weight:800;color:rgba(232,238,252,.90);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;min-width:0}
    .tile .val{font-family:var(--mono);font-size:12px;font-weight:950;display:flex;align-items:baseline;gap:6px;min-width:0;flex-wrap:wrap}
    .tile .val small{font-size:10px;font-weight:850;color:rgba(232,238,252,.82);white-space:nowrap}
    .tile[aria-current="true"]{outline:2px solid rgba(122,167,255,.7);box-shadow: 0 0 0 6px rgba(122,167,255,.15)}
    .foot{margin-top:12px;color:var(--muted);font-size:12px;line-height:1.4;display:flex;flex-wrap:wrap;gap:10px;justify-content:space-between;align-items:center}
    .toast{
      position:fixed;left:50%;bottom:18px;transform:translateX(-50%);
      background: rgba(10,18,35,.92);border:1px solid var(--border);box-shadow: var(--shadow);
      color:var(--text);padding:10px 12px;border-radius:14px;font-size:13px;font-weight:750;
      display:none;max-width:min(540px, calc(100vw - 28px));
    }
    .toast.show{display:block}
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="title">
        <h1>P√∂rssis√§hk√∂ ‚Äì varttihinnat</h1>
        <p>Ajat n√§ytet√§√§n Suomen ajassa. Data tulee ensisijaisesti <span class="t">/data/latest-prices.json</span> (GitHub Action), varalla suora API.</p>
      </div>

      <div class="actions">
        <div class="seg" role="group" aria-label="N√§kym√§">
          <button data-mode="future" aria-pressed="true">Tulevat</button>
          <button data-mode="past" aria-pressed="false">Menneet</button>
        </div>
        <div class="seg" role="group" aria-label="Aikav√§li">
          <button data-range="1"  aria-pressed="false">1h</button>
          <button data-range="12" aria-pressed="false">12h</button>
          <button data-range="24" aria-pressed="true">24h</button>
          <button data-range="48" aria-pressed="false">48h</button>
        </div>
        <button id="refreshBtn" title="P√§ivit√§">P√§ivit√§</button>
      </div>
    </header>

    <div class="grid">
      <section class="card">
        <div class="inner">
          <div class="now">
            <div class="big">
              <div class="label" id="nowLabel">Seuraava hinta (l√§hin vartti)</div>
              <div class="price">
                <span id="nowPrice">‚Äî</span>
                <span class="unit">snt / kWh</span>
              </div>
              <div class="trend" id="trendPill" aria-live="polite">
                <span class="dot" id="trendDot"></span>
                <span id="trendText">Haetaan dataa‚Ä¶</span>
              </div>
            </div>

            <div class="meta">
              <div class="row">
                <div class="k">N√§kym√§</div>
                <div class="v" id="modeLabel">Tulevat</div>
              </div>
              <div class="row">
                <div class="k">Aikav√§li</div>
                <div class="v" id="rangeLabel">24h</div>
              </div>
              <div class="row">
                <div class="k">Min / Max</div>
                <div class="v"><span id="minVal">‚Äî</span> / <span id="maxVal">‚Äî</span></div>
              </div>
              <div class="row">
                <div class="k">Keskiarvo</div>
                <div class="v" id="avgVal">‚Äî</div>
              </div>
              <div class="row">
                <div class="k">Viimeisin p√§ivitys</div>
                <div class="v" id="updatedAt">‚Äî</div>
              </div>
            </div>
          </div>

          <div style="height:12px"></div>

          <div class="chartWrap">
            <div class="chartHead">
              <h2 id="chartTitle">Tulevat hinnat</h2>
              <div class="status" id="statusBox">
                <span class="spinner" id="spin" aria-hidden="true"></span>
                <span id="statusText">Ladataan‚Ä¶</span>
              </div>
            </div>

            <svg class="svgBox" id="chart" viewBox="0 0 1000 320" preserveAspectRatio="none" role="img" aria-label="Hintak√§yr√§"></svg>

            <div class="legend" aria-hidden="true">
              <div class="item"><span class="line"></span> Hinta</div>
              <div class="item"><span class="mark"></span> Nykyhetki</div>
            </div>
          </div>

          <div class="foot">
            <div>Huom: huomisen hinnat n√§kyv√§t yleens√§ vasta kun ne ovat julkaistu (tyypillisesti iltap√§iv√§ll√§).</div>
            <div><span class="t">L√§hde:</span> <span class="t" id="sourceLabel">‚Äî</span></div>
          </div>
        </div>
      </section>

      <aside class="card">
        <div class="inner list">
          <h2>√Ñ√§riarvot valitulta aikav√§lilt√§</h2>
          <div class="cols">
            <div class="mini">
              <h3>Halvimmat</h3>
              <ul id="cheapList"></ul>
            </div>
            <div class="mini">
              <h3>Kalleimmat</h3>
              <ul id="expList"></ul>
            </div>
          </div>

          <div style="height:12px"></div>

          <div class="heat">
            <div class="heatHead">
              <h2>Varttiruudukko</h2>
              <div class="hint">V√§ri = suhteellinen hinta</div>
            </div>
            <div class="tiles" id="tiles" aria-label="Varttikohtaiset hinnat"></div>
          </div>
        </div>
      </aside>
    </div>
  </div>

  <div class="toast" id="toast" role="status" aria-live="polite"></div>

  <script>
    console.log('üîß DEBUG: Sovellus k√§ynnistyy');
    console.log('üîß DEBUG: Viewport width:', window.innerWidth);
    console.log('üîß DEBUG: Viewport height:', window.innerHeight);
    
    window.addEventListener('resize', () => {
      console.log('üîß DEBUG: Resize event - width:', window.innerWidth, 'height:', window.innerHeight);
    });

    // API docs: v2/latest-prices.json and v2/price.json
    const API_ENDPOINT = 'https://api.porssisahko.net/v2/latest-prices.json';
    const LOCAL_ENDPOINT = './data/latest-prices.json'; // generated by GitHub Action

    const el = (id) => document.getElementById(id);

    const ui = {
      nowLabel: el('nowLabel'),
      nowPrice: el('nowPrice'),
      trendText: el('trendText'),
      trendDot: el('trendDot'),
      modeLabel: el('modeLabel'),
      rangeLabel: el('rangeLabel'),
      chartTitle: el('chartTitle'),
      minVal: el('minVal'),
      maxVal: el('maxVal'),
      avgVal: el('avgVal'),
      updatedAt: el('updatedAt'),
      cheapList: el('cheapList'),
      expList: el('expList'),
      tiles: el('tiles'),
      chart: el('chart'),
      statusText: el('statusText'),
      spin: el('spin'),
      toast: el('toast'),
      sourceLabel: el('sourceLabel')
    };

    let state = {
      all: [],
      mode: 'future',    // 'future' | 'past'
      rangeHours: 24,
      lastUpdated: null
    };

    function showToast(msg){
      ui.toast.textContent = msg;
      ui.toast.classList.add('show');
      clearTimeout(showToast._t);
      showToast._t = setTimeout(()=>ui.toast.classList.remove('show'), 2200);
    }

    function formatFiTime(d){
      return new Intl.DateTimeFormat('fi-FI', {
        weekday:'short', hour:'2-digit', minute:'2-digit', day:'2-digit', month:'2-digit'
      }).format(d);
    }

    function quantile(sortedArr, q){
      if(!sortedArr.length) return 0;
      const pos = (sortedArr.length - 1) * q;
      const base = Math.floor(pos);
      const rest = pos - base;
      if(sortedArr[base + 1] === undefined) return sortedArr[base];
      return sortedArr[base] + rest * (sortedArr[base + 1] - sortedArr[base]);
    }

    function calcStats(entries){
      const vals = entries.map(x=>x.price);
      const min = Math.min(...vals);
      const max = Math.max(...vals);
      const avg = vals.reduce((a,b)=>a+b,0) / (vals.length || 1);
      const sorted = [...vals].sort((a,b)=>a-b);
      const q1 = quantile(sorted, 0.25);
      const q3 = quantile(sorted, 0.75);
      return {min, max, avg, q1, q3};
    }

    function formatPrice(p){ return (Math.round(p * 100) / 100).toFixed(2); }

    function tileBg(p, q1, q3){
      if(p <= q1) return 'rgba(83, 209, 138, .22)';
      if(p >= q3) return 'rgba(255, 92, 122, .22)';
      return 'rgba(255, 209, 102, .18)';
    }
    function tileBorder(p, q1, q3){
      if(p <= q1) return 'rgba(83, 209, 138, .40)';
      if(p >= q3) return 'rgba(255, 92, 122, .40)';
      return 'rgba(255, 209, 102, .30)';
    }
    function priceClass(p, q1, q3){
      if(p <= q1) return 'good';
      if(p >= q3) return 'bad';
      return 'mid';
    }

    function setLoading(isLoading, text){
      ui.statusText.textContent = text || (isLoading ? 'Ladataan‚Ä¶' : 'Valmis');
      ui.spin.style.display = isLoading ? 'inline-block' : 'none';
    }

    function parsePrices(raw){
      const arr = (raw && raw.prices) ? raw.prices : [];
      return arr.map(x => ({
          price: Number(x.price),
          start: new Date(x.startDate),
          end: new Date(x.endDate),
          startIso: x.startDate,
          endIso: x.endDate
      })).filter(x => Number.isFinite(x.price) && !isNaN(x.start));
    }

    function nearestQuarterFromNow(entries){
      const now = new Date();
      // "future": first entry with end > now (so current or next). We prefer next start >= now, but allow "current" as nearest.
      const futureStarts = entries.filter(e => e.start >= now).sort((a,b)=>a.start-b.start);
      if(futureStarts.length) return futureStarts[0];
      // fallback: current
      const current = entries.find(e => e.start <= now && e.end > now);
      return current || null;
    }

    function sliceWindow(entries, mode, rangeHours){
      const now = new Date();
      const ms = rangeHours * 3600 * 1000;

      if(mode === 'future'){
        const to = new Date(now.getTime() + ms);
        return entries.filter(e => e.start >= now && e.start <= to).sort((a,b)=>a.start-b.start);
      } else {
        const from = new Date(now.getTime() - ms);
        return entries.filter(e => e.start >= from && e.start <= now).sort((a,b)=>a.start-b.start);
      }
    }

    function drawChart(entries){
      const W=1000,H=320,padL=54,padR=18,padT=18,padB=46;
      const w=W-padL-padR,h=H-padT-padB;

      if(entries.length < 2){
        ui.chart.innerHTML = `
          <text x="50%" y="50%" fill="rgba(255,255,255,.60)" font-size="14" text-anchor="middle">
            Ei riitt√§v√§sti dataa t√§h√§n n√§kym√§√§n.
          </text>`;
        return;
      }

      const vals = entries.map(e=>e.price);
      const min = Math.min(...vals);
      const max = Math.max(...vals);
      const span = (max-min) || 1;

      const x = (i)=> padL + (i/(entries.length-1))*w;
      const y = (v)=> padT + (1-(v-min)/span)*h;

      // Grid
      const grid=[];
      const stepsY=4;
      for(let i=0;i<=stepsY;i++){
        const yy=padT+(i/stepsY)*h;
        grid.push(`<line x1="${padL}" y1="${yy}" x2="${W-padR}" y2="${yy}" stroke="rgba(255,255,255,.07)" stroke-width="1" />`);
      }
      const stepsX=6;
      for(let i=0;i<=stepsX;i++){
        const xx=padL+(i/stepsX)*w;
        grid.push(`<line x1="${xx}" y1="${padT}" x2="${xx}" y2="${H-padB}" stroke="rgba(255,255,255,.06)" stroke-width="1" />`);
      }

      // Path
      let d='';
      entries.forEach((e,i)=>{
        const xx=x(i), yy=y(e.price);
        d += (i===0 ? `M ${xx} ${yy}` : ` L ${xx} ${yy}`);
      });

      // "now" marker line (current time position within window, not tied to a data point)
      const now = new Date();
      const startT = entries[0].start.getTime();
      const endT = entries[entries.length-1].start.getTime();
      let nowMarkup = '';
      if(now.getTime() >= startT && now.getTime() <= endT){
        const t = (now.getTime()-startT)/(endT-startT || 1);
        const nx = padL + t*w;
        nowMarkup = `<line x1="${nx}" y1="${padT}" x2="${nx}" y2="${H-padB}" stroke="rgba(155,125,255,.35)" stroke-width="2" />`;
      }

      const startLbl = formatFiTime(entries[0].start);
      const endLbl = formatFiTime(entries[entries.length-1].start);

      ui.chart.innerHTML = `
        <rect x="0" y="0" width="${W}" height="${H}" fill="transparent" />
        ${grid.join('')}
        <path d="${d}" fill="none" stroke="rgba(122,167,255,.95)" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
        ${nowMarkup}
        <line x1="${padL}" y1="${padT}" x2="${padL}" y2="${H-padB}" stroke="rgba(255,255,255,.10)" stroke-width="1.5" />
        <line x1="${padL}" y1="${H-padB}" x2="${W-padR}" y2="${H-padB}" stroke="rgba(255,255,255,.10)" stroke-width="1.5" />
        <text x="${padL}" y="${H-18}" fill="rgba(255,255,255,.55)" font-size="12" font-family="${getComputedStyle(document.documentElement).getPropertyValue('--mono')}">${startLbl}</text>
        <text x="${W-padR}" y="${H-18}" fill="rgba(255,255,255,.55)" font-size="12" text-anchor="end" font-family="${getComputedStyle(document.documentElement).getPropertyValue('--mono')}">${endLbl}</text>
        <text x="${padL-10}" y="${y(max)+4}" fill="rgba(255,255,255,.55)" font-size="12" text-anchor="end" font-family="${getComputedStyle(document.documentElement).getPropertyValue('--mono')}">${formatPrice(max)}</text>
        <text x="${padL-10}" y="${y(min)+4}" fill="rgba(255,255,255,.55)" font-size="12" text-anchor="end" font-family="${getComputedStyle(document.documentElement).getPropertyValue('--mono')}">${formatPrice(min)}</text>
      `;
    }

    function render(){
      console.log('üîß DEBUG: render() - aloitus');
      console.log('üîß DEBUG: state.all.length:', state.all.length);
      console.log('üîß DEBUG: state.mode:', state.mode);
      console.log('üîß DEBUG: state.rangeHours:', state.rangeHours);
      
      if(!state.all.length) return;

      const window = sliceWindow(state.all, state.mode, state.rangeHours);
      console.log('üîß DEBUG: window.length:', window.length);
      ui.modeLabel.textContent = state.mode === 'future' ? 'Tulevat' : 'Menneet';
      ui.chartTitle.textContent = state.mode === 'future' ? 'Tulevat hinnat' : 'Menneet hinnat';
      ui.rangeLabel.textContent = `${state.rangeHours}h`;

      if(!window.length){
        ui.nowLabel.textContent = state.mode === 'future' ? 'Seuraava hinta' : 'Hinta viime vartilta';
        ui.nowPrice.textContent = '‚Äî';
        ui.trendText.textContent = state.mode === 'future'
          ? 'Tulevia hintoja ei ole saatavilla t√§ss√§ datassa (huomisen hinnat eiv√§t ehk√§ viel√§ ole julkaistu).'
          : 'Menneit√§ hintoja ei l√∂ytynyt t√§lle ikkunalle.';
        ui.trendDot.style.background = 'rgba(255,255,255,.35)';
        ui.minVal.textContent = ui.maxVal.textContent = ui.avgVal.textContent = '‚Äî';
        ui.tiles.innerHTML = '';
        ui.cheapList.innerHTML = '';
        ui.expList.innerHTML = '';
        drawChart(window);
        return;
      }

      const stats = calcStats(window);
      ui.minVal.textContent = formatPrice(stats.min);
      ui.maxVal.textContent = formatPrice(stats.max);
      ui.avgVal.textContent = formatPrice(stats.avg);

      // Card main value
      if(state.mode === 'future'){
        const next = nearestQuarterFromNow(state.all);
        if(next){
          ui.nowLabel.textContent = 'Seuraava hinta (l√§hin vartti)';
          ui.nowPrice.textContent = formatPrice(next.price);
          ui.trendText.innerHTML = `<b>${formatFiTime(next.start)}</b> ¬∑ alkaa`;
          ui.trendDot.style.background = 'var(--accent2)';
        } else {
          ui.nowLabel.textContent = 'Seuraava hinta';
          ui.nowPrice.textContent = '‚Äî';
          ui.trendText.textContent = 'Seuraavaa varttia ei l√∂ytynyt datasta.';
          ui.trendDot.style.background = 'rgba(255,255,255,.35)';
        }
      } else {
        const last = window[window.length-1];
        ui.nowLabel.textContent = 'Hinta (viimeisin vartti ikkunassa)';
        ui.nowPrice.textContent = formatPrice(last.price);
        ui.trendText.innerHTML = `<b>${formatFiTime(last.start)}</b> ¬∑ p√§√§ttyy ${formatFiTime(last.end)}`;
        ui.trendDot.style.background = 'var(--accent)';
      }

      // Top lists
      const sorted = [...window].sort((a,b)=>a.price-b.price);
      const cheapest = sorted.slice(0, 8);
      const expensive = sorted.slice(-8).reverse();
      const liHtml = (e, cls) => `
        <li>
          <span class="t">${formatFiTime(e.start)}</span>
          <span class="p ${cls}">${formatPrice(e.price)}</span>
        </li>`;
      ui.cheapList.innerHTML = cheapest.map(e => liHtml(e, priceClass(e.price, stats.q1, stats.q3))).join('');
      ui.expList.innerHTML = expensive.map(e => liHtml(e, priceClass(e.price, stats.q1, stats.q3))).join('');

      // Tiles
      console.log('üîß DEBUG: Render√∂id√§√§n tiles, m√§√§r√§:', window.length);
      ui.tiles.innerHTML = '';
      
      // Debug parent widths
      const debugElement = (el, name) => {
        console.log(`üîß DEBUG: ${name} - offsetWidth: ${el.offsetWidth}, clientWidth: ${el.clientWidth}, scrollWidth: ${el.scrollWidth}`);
        const computed = window.getComputedStyle(el);
        console.log(`üîß DEBUG: ${name} - width: ${computed.width}, max-width: ${computed.maxWidth}, box-sizing: ${computed.boxSizing}`);
      };
      
      debugElement(ui.tiles, 'tiles');
      debugElement(ui.tiles.parentElement, 'tiles.parent (.heat)');
      debugElement(ui.tiles.parentElement.parentElement, 'tiles.parent.parent');
      debugElement(document.querySelector('.grid'), 'grid');
      debugElement(document.querySelector('.wrap'), 'wrap');
      
      for(const e of window){
        const tile = document.createElement('button');
        tile.type = 'button';
        tile.className = 'tile';
        tile.style.background = tileBg(e.price, stats.q1, stats.q3);
        tile.style.borderColor = tileBorder(e.price, stats.q1, stats.q3);
        tile.setAttribute('aria-label', `${formatFiTime(e.start)}: ${formatPrice(e.price)} snt / kWh`);
        tile.innerHTML = `
          <div class="time">${formatFiTime(e.start)}</div>
          <div class="val">${formatPrice(e.price)} <small>snt/kWh</small></div>
        `;
        tile.addEventListener('click', () => showToast(`${formatFiTime(e.start)} ¬∑ ${formatPrice(e.price)} snt/kWh`));
        ui.tiles.appendChild(tile);
      }
      console.log('üîß DEBUG: Tiles render√∂ity, tiles container width:', ui.tiles.offsetWidth);
      console.log('üîß DEBUG: Tiles grid computed style:', window.getComputedStyle(ui.tiles).gridTemplateColumns);

      drawChart(window);
    }

    async function fetchJson(url){
      const res = await fetch(url, { cache: 'no-store' });
      if(!res.ok) throw new Error(`HTTP ${res.status}`);
      return res.json();
    }

    async function loadData(force){
      setLoading(true, 'Haetaan‚Ä¶');

      // 1) Prefer local file (works on GitHub Pages always)
      try{
        const local = await fetchJson(LOCAL_ENDPOINT + (force ? `?t=${Date.now()}` : ''));
        const parsed = parsePrices(local);
        if(parsed.length){
          state.all = parsed.sort((a,b)=>a.start-b.start);
          state.lastUpdated = new Date(local.generatedAt || Date.now());
          ui.updatedAt.textContent = formatFiTime(state.lastUpdated);
          ui.sourceLabel.textContent = 'local (/data/latest-prices.json)';
          setLoading(false, 'Valmis');
          render();
          return;
        }
      } catch (_) {
        // ignore and try API
      }

      // 2) Try direct API (may fail due to CORS in browser)
      try{
        const api = await fetchJson(API_ENDPOINT);
        const parsed = parsePrices(api);
        if(!parsed.length) throw new Error('Tyhj√§ data');
        state.all = parsed.sort((a,b)=>a.start-b.start);
        state.lastUpdated = new Date();
        ui.updatedAt.textContent = formatFiTime(state.lastUpdated);
        ui.sourceLabel.textContent = 'API (direct)';
        setLoading(false, 'Valmis');
        render();
        return;
      } catch (err){
        setLoading(false, 'Virhe');
        ui.sourceLabel.textContent = '‚Äî';
        showToast(`Datan haku ep√§onnistui (todenn√§k√∂isesti CORS). Ota GitHub Action k√§ytt√∂√∂n. (${err.message || err})`);
      }
    }

    function setLoading(isLoading, text){
      ui.statusText.textContent = text || (isLoading ? 'Ladataan‚Ä¶' : 'Valmis');
      ui.spin.style.display = isLoading ? 'inline-block' : 'none';
    }

    // Buttons: mode
    document.querySelectorAll('[data-mode]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const m = btn.dataset.mode;
        state.mode = m;
        document.querySelectorAll('[data-mode]').forEach(b=>{
          b.setAttribute('aria-pressed', b.dataset.mode === m ? 'true' : 'false');
        });
        render();
      });
    });

    // Buttons: range
    document.querySelectorAll('[data-range]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const r = Number(btn.dataset.range);
        state.rangeHours = r;
        document.querySelectorAll('[data-range]').forEach(b=>{
          b.setAttribute('aria-pressed', Number(b.dataset.range) === r ? 'true' : 'false');
        });
        render();
      });
    });

    // Refresh
    el('refreshBtn').addEventListener('click', ()=>loadData(true));

    // Init
    loadData(false);
  </script>
</body>
</html>
